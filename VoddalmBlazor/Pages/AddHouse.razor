@page "/AddHouse"
@using System.Net.Http
@inject HttpClient httpClient
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using VoddalmBlazor.Models
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Admin")]

<h3>Add Housing</h3>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<form @onsubmit="HandleSubmit">
    <div class="form-group">
        <label for="address">Address</label>
        <input type="text" class="form-control" @bind="housing.address" id="address">
    </div>
    <div class="form-group">
        <label for="initialPrice">Initial Price</label>
        <input type="number" class="form-control" @bind="housing.initialPrice" id="initialPrice">
    </div>
    <div class="form-group">
        <label for="livingArea">Living Area (sq ft)</label>
        <input type="number" class="form-control" @bind="housing.livingArea" id="livingArea">
    </div>
    <div class="form-group">
        <label for="additionalArea">Additional Area (sq ft)</label>
        <input type="number" class="form-control" @bind="housing.additionalArea" id="additionalArea">
    </div>
    <div class="form-group">
        <label for="plotArea">Plot Area (sq ft)</label>
        <input type="number" class="form-control" @bind="housing.plotArea" id="plotArea">
    </div>
    <div class="form-group">
        <label for="description">Description</label>
        <textarea class="form-control" @bind="housing.description" id="description"></textarea>
    </div>
    <div class="form-group">
        <label for="numberOfRooms">Number of Rooms</label>
        <input type="number" class="form-control" @bind="housing.numberOfRooms" id="numberOfRooms">
    </div>
    <div class="form-group">
        <label for="monthlyFee">Monthly Fee</label>
        <input type="number" class="form-control" @bind="housing.monthlyFee" id="monthlyFee">
    </div>
    <div class="form-group">
        <label for="annualOperatingCost">Annual Operating Cost</label>
        <input type="number" class="form-control" @bind="housing.annualOperatingCost" id="annualOperatingCost">
    </div>
    <div class="form-group">
        <label for="yearBuilt">Year Built</label>
        <input type="number" class="form-control" @bind="housing.yearBuilt" id="yearBuilt">
    </div>

    <div class="form-group">
        <label for="broker">Broker</label>
        <select class="form-control" @bind="housing.brokerId">
            <option value="">Select Broker</option>
            @if (brokers != null)
            {
                @foreach (var broker in brokers.DistinctBy(b => b.id))
                {
                    <option value="@broker.id">@broker.firstName @broker.lastName</option>
                }
            }
            else
            {
                <option value="">Loading...</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="municipality">Municipality</label>
        <select class="form-control" @bind="housing.municipalityId">
            <option value="">Select Municipality</option>
            @if (housingList != null)
            {
                @foreach (var municipality in housingList.DistinctBy(b => b.municipalityId))
                {
                    if (municipality != null && municipality.municipality != null)
                    {
                        <option value="@municipality.id">@municipality.municipality.name</option>
                    }
                }
            }
            else
            {
                <option value="">Loading...</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="category">Category</label>
        <select class="form-control" @bind="housing.categoryId">
            <option value="">Select Category</option>
            @if (housingList != null)
            {
                @foreach (var category in housingList.DistinctBy(b => b.categoryId))
                {
                    if (category != null && category.category != null)
                    {
                        <option value="@category.id">@category.category.name</option>
                    }
                }
            }
            else
            {
                <option value="">Loading...</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="images">Images URLs</label>
        <input type="text" class="form-control" @bind="imageUrls" id="images">
    </div>

    @if (!string.IsNullOrWhiteSpace(imageUrls))
    {
        @foreach (var imageUrl in imageUrls.Split(','))
        {
            <div>
                <img src="@imageUrl" alt="Housing Image">
            </div>
        }
    }
    else
    {
        <div>
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Image.jpg" alt="Default Housing Image">
        </div>
    }

    <button type="submit" class="btn btn-primary">Submit</button>
</form>

@code {
    private Housing housing = new Housing();
    private string imageUrls;
    private string errorMessage;

    private List<Broker> brokers;
    private List<Housing> housingList;

    protected override async Task OnInitializedAsync()
    {
        // Fetch data for dropdown lists from your API
        brokers = await httpClient.GetFromJsonAsync<List<Broker>>("https://localhost:7046/api/Broker");
        housingList = await httpClient.GetFromJsonAsync<List<Housing>>("https://localhost:7046/api/Housings");

        // Set default image URL
        imageUrls = "https://upload.wikimedia.org/wikipedia/commons/7/78/Image.jpg";
    }

    private async Task HandleSubmit()
    {
        try
        {
            housing.Images = imageUrls?.Split(',').ToList();
            HttpResponseMessage response = await httpClient.PostAsJsonAsync("https://localhost:7046/api/Housings", housing);
            response.EnsureSuccessStatusCode(); // Ensure success status code

            // Navigate to the confirmation page with the housing object as a query parameter
            NavigationManager.NavigateTo("/AddHouseConfirmationTemp");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}